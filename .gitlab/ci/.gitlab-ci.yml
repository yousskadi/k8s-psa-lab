# .gitlab/ci/.gitlab-ci.yml
# Pipeline GitLab CI pour le lab PSA
# Copier ce fichier à la racine du repo comme .gitlab-ci.yml

variables:
  KIND_VERSION: "v0.20.0"
  KUBECTL_VERSION: "v1.28.0"
  CLUSTER_NAME: "psa-ci-${CI_JOB_ID}"

stages:
  - lint
  - test
  - report

# ────────────────────────────────────────────────────────────────
# Templates réutilisables
# ────────────────────────────────────────────────────────────────
.setup_kind: &setup_kind
  before_script:
    # Installer Kind
    - curl -Lo ./kind "https://kind.sigs.k8s.io/dl/${KIND_VERSION}/kind-linux-amd64"
    - chmod +x ./kind && mv ./kind /usr/local/bin/kind
    # Installer kubectl
    - curl -Lo ./kubectl "https://dl.k8s.io/release/${KUBECTL_VERSION}/bin/linux/amd64/kubectl"
    - chmod +x ./kubectl && mv ./kubectl /usr/local/bin/kubectl
    # Installer jq
    - apt-get update -qq && apt-get install -y -qq jq
    # Créer le cluster
    - kind create cluster --name "${CLUSTER_NAME}" --config kind/cluster-simple.yaml
    - kubectl cluster-info --context "kind-${CLUSTER_NAME}"
    - kubectl wait --for=condition=Ready nodes --all --timeout=120s
    - chmod +x scripts/*.sh tests/*.sh

.cleanup_kind: &cleanup_kind
  after_script:
    - kind delete cluster --name "${CLUSTER_NAME}" 2>/dev/null || true

# ────────────────────────────────────────────────────────────────
# Stage 1 : Lint
# ────────────────────────────────────────────────────────────────
lint:yaml:
  stage: lint
  image: python:3.11-alpine
  script:
    - pip install yamllint -q
    - yamllint -d relaxed manifests/ kind/ || true
    - echo "✅ YAML lint OK"
  rules:
    - if: '$CI_PIPELINE_SOURCE == "merge_request_event"'
    - if: '$CI_COMMIT_BRANCH == "main"'

lint:helm:
  stage: lint
  image: alpine/helm:3.13.0
  script:
    - helm lint ./helm/psa-namespace --strict
    - echo "✅ Helm lint OK"
  rules:
    - if: '$CI_PIPELINE_SOURCE == "merge_request_event"'
    - if: '$CI_COMMIT_BRANCH == "main"'

# ────────────────────────────────────────────────────────────────
# Stage 2 : Tests d'intégration
# ────────────────────────────────────────────────────────────────
test:lab-baseline:
  stage: test
  image: docker:24-dind
  services:
    - docker:24-dind
  variables:
    DOCKER_HOST: tcp://docker:2376
    DOCKER_TLS_CERTDIR: "/certs"
  <<: *setup_kind
  script:
    - ./tests/test-lab2-baseline.sh
  <<: *cleanup_kind
  artifacts:
    when: always
    reports:
      junit: test-results-baseline.xml
    expire_in: 1 week
  rules:
    - if: '$CI_PIPELINE_SOURCE == "merge_request_event"'
    - if: '$CI_COMMIT_BRANCH == "main"'

test:lab-restricted:
  stage: test
  image: docker:24-dind
  services:
    - docker:24-dind
  variables:
    DOCKER_HOST: tcp://docker:2376
    DOCKER_TLS_CERTDIR: "/certs"
  <<: *setup_kind
  script:
    - ./tests/test-lab3-restricted.sh
  <<: *cleanup_kind
  artifacts:
    when: always
    expire_in: 1 week
  rules:
    - if: '$CI_PIPELINE_SOURCE == "merge_request_event"'
    - if: '$CI_COMMIT_BRANCH == "main"'

test:dry-run-production:
  stage: test
  image: docker:24-dind
  services:
    - docker:24-dind
  variables:
    DOCKER_HOST: tcp://docker:2376
    DOCKER_TLS_CERTDIR: "/certs"
  <<: *setup_kind
  script:
    # Appliquer les namespaces
    - kubectl apply -f manifests/00-namespaces/
    # Dry-run de tous les manifests
    - |
      for f in $(find manifests/ -name '*.yaml' ! -path '*/00-namespaces/*'); do
        echo "Testing: $f"
        kubectl apply --dry-run=server -f "$f" 2>&1 || true
      done
    - echo "✅ Dry-run production OK"
    # Rapport d'audit
    - ./scripts/audit-namespaces.sh
  <<: *cleanup_kind
  rules:
    - if: '$CI_COMMIT_BRANCH == "main"'

# ────────────────────────────────────────────────────────────────
# Stage 3 : Rapport
# ────────────────────────────────────────────────────────────────
report:compliance:
  stage: report
  image: alpine:3.19
  script:
    - apk add -q bash
    - echo "=== Rapport de conformité PSA ===" > compliance-report.txt
    - echo "Date: $(date)" >> compliance-report.txt
    - echo "" >> compliance-report.txt
    - |
      for f in manifests/00-namespaces/*.yaml; do
        NS=$(grep "name:" "$f" | head -1 | awk '{print $2}')
        ENF=$(grep "enforce:" "$f" | grep -v "version" | head -1 | awk '{print $2}' || echo "N/A")
        echo "Namespace: $NS | Enforce: $ENF" >> compliance-report.txt
      done
    - cat compliance-report.txt
  artifacts:
    paths:
      - compliance-report.txt
    expire_in: 30 days
  rules:
    - if: '$CI_COMMIT_BRANCH == "main"'
